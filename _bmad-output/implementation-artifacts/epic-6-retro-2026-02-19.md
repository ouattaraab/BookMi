# Rétrospective — Épic 6 : Suivi Jour J & Évaluation

**Date :** 2026-02-19
**Facilitateur :** Bob (Scrum Master)
**Projet :** BookMi_v2 — Marketplace de réservation de talents en Côte d'Ivoire
**Stack :** Laravel 12 (backend) · Flutter 3 (mobile) · WebSocket / Broadcasting

---

## Métriques de l'Épic

| Indicateur              | Valeur        |
|-------------------------|---------------|
| Stories planifiées      | 9             |
| Stories livrées (done)  | 9             |
| Taux de complétion      | **100 %**     |
| Vélocité épic           | 9 / 9         |
| Stories backend         | 7 (6-1 à 6-7) |
| Stories Flutter         | 2 (6-8, 6-9)  |

---

## Participants

- **Bob** — Scrum Master & facilitateur
- **Alice** — Product Owner
- **Charlie** — Senior Dev (Backend Laravel)
- **Dana** — QA Engineer
- **Elena** — Junior Dev (Flutter)
- **Aboubakarouattara** — Project Lead

---

## Ouverture

**Bob (Scrum Master):**
"Bonjour tout le monde, on se retrouve pour la rétrospective de l'Épic 6 — Suivi Jour J & Évaluation. C'était une épic musclée : GPS temps réel, broadcasting WebSocket, système d'évaluation bidirectionnel, enrichissement de portfolio… 9 stories, 9 done. 100 %. Je vous invite à prendre deux secondes pour savourer ça avant qu'on rentre dans le vif du sujet."

**Alice (Product Owner):**
"Je vais commencer par féliciter toute l'équipe. Du point de vue fonctionnel, cette épic délivre la colonne vertébrale du 'Jour J' pour BookMi : le client peut suivre son talent en temps réel, les deux parties peuvent s'évaluer mutuellement, et le talent peut enrichir son portfolio directement après la prestation. C'est un différenciateur fort sur le marché ivoirien."

**Aboubakarouattara (Project Lead):**
"Exactement. Et ce qui me plaît, c'est qu'on a livré sans dette fonctionnelle cachée. On a documenté honnêtement les action items comme la race condition sur `preparing`. C'est de la maturité d'équipe."

---

## Succès

### Ce qui a bien fonctionné

**Bob (Scrum Master):**
"Passons en revue nos grandes victoires. Charlie, commence."

**Charlie (Senior Dev):**
"Trois choses côté backend. D'abord, le **tracker GPS temps réel (Story 6-1)** : l'enum `TrackingStatus` avec `allowedTransitions()` / `canTransitionTo()` est élégant. Les transitions sont forward-only et auto-documentées. Zéro logique de validation dispersée dans le controller — tout dans l'enum et le service. C'est exactement le type d'architecture qu'on veut propager sur tout le projet.

Deuxièmement, le **broadcasting WebSocket** via `ShouldBroadcast` sur `PresenceChannel('tracking.{bookingId}')` : les deux parties reçoivent les mises à jour sans polling. Et on a bien protégé la DB en entourant `broadcast()` d'un try/catch avec `Log::error` — si Reverb tombe, la transaction DB n'est pas annulée.

Troisièmement, le **système d'évaluation bidirectionnel (Stories 6-4 et 6-5)** : un seul endpoint `/reviews` avec un `type` (`client_to_talent` / `talent_to_client`), des guards pour empêcher une double évaluation, et un calcul de score moyen automatique sur le profil talent. Simple, propre, extensible."

**Elena (Junior Dev):**
"Côté Flutter, je suis fière de l'écran tracker (Story 6-8). La **timeline verticale à 5 étapes** avec les nodes colorés/grisés c'est exactement ce qu'Alice avait en tête dans les wireframes. Et l'overlay `_CelebrationOverlay` avec `FadeTransition` quand la prestation est terminée — c'était un petit plus qu'on n'avait pas prévu initialement, et ça crée un vrai moment de satisfaction pour l'utilisateur.

Pour l'écran évaluation (Story 6-9), le widget `_StarRating` avec les `GestureDetector` wrappés sur les étoiles, les couleurs `ctaOrange` / `white30`, et l'animation élastique de `_SuccessScreen` (`FadeTransition` + `ScaleTransition`) — tout ça donne une UX premium sans librairie externe."

**Dana (QA Engineer):**
"De mon côté, la **couverture de tests** a été exemplaire sur cette épic :
- Story 6-1 : 15 tests Feature + 4 tests Unit sur l'enum. La séquence complète des 5 statuts est testée, les transitions backward, les erreurs 403/422/401, les coordonnées GPS invalides, les booking inactifs.
- Story 6-8 : 6 cas Cubit couvrant le chemin heureux, les erreurs réseau, l'optimistic UI et le revert.
- Story 6-9 : 6 cas Cubit avec le fallback `Submitted` même si le reload post-submit échoue.

Ce niveau de couverture me permet de valider les AC sans tests manuels répétitifs. C'est un vrai gain de temps en cycle."

**Alice (Product Owner):**
"Je veux également souligner la **Story 6-7 (Enrichissement Portfolio)**. Les talents peuvent ajouter photos et notes directement après la prestation, dans la continuité du flux. Ça va considérablement améliorer la qualité des portfolios sur la plateforme — et donc la conversion côté clients."

---

## Challenges

### Ce qui a été difficile

**Bob (Scrum Master):**
"On va maintenant parler franchement des points durs. Le but c'est d'apprendre, pas de blâmer. Charlie ?"

**Charlie (Senior Dev):**
"Le challenge technique le plus sérieux a été la **gestion des permissions GPS sur mobile**. La Story 6-2 (Check-in géolocalisation) et la Story 6-3 (Alerte check-in manquant) ont nécessité qu'Elena et moi synchronisions nos implémentations : le backend stocke `latitude` et `longitude` en `DECIMAL(10,7)`, mais côté mobile, on a dû gérer les cas où l'OS refuse les permissions, où le GPS est imprécis en zone dense (comme Abidjan plateau), et où l'utilisateur a coupé la localisation en fond.

On n'avait pas anticipé le **flow de demande de permissions** dans le Cubit. Elena a dû ajouter une gestion d'état intermédiaire pour les cas `permission_denied` vs `permission_denied_forever` vs `location_service_disabled`."

**Elena (Junior Dev):**
"Oui, et le **pattern `TrackingUpdating extends TrackingLoaded`** (Story 6-8) m'a posé un problème subtil : Bloc supprimait l'émission parce que `TrackingUpdating` et `TrackingLoaded` étaient considérés égaux par l'opérateur `==` hérité. J'ai perdu presque une demi-journée à déboguer ça avant de comprendre qu'il fallait ajouter un guard `runtimeType == other.runtimeType &&` dans l'opérateur d'égalité. C'est une subtilité Bloc/Equatable qui n'est pas évidente dans la doc."

**Dana (QA Engineer):**
"Côté QA, j'ai eu de la difficulté à tester les **scénarios de race condition** sur la Story 6-1. Le problème M1 documenté — deux requêtes `preparing` concurrentes — est réel. En test de charge basique, j'ai pu reproduire la création de deux `TrackingEvent` avec le même statut. L'action item est documenté, mais ça reste une fragilité."

**Charlie (Senior Dev):**
"Et plus globalement, le **système de notation (Stories 6-4 / 6-5)** a demandé plus d'itérations que prévu sur la logique de calcul du score moyen. On voulait éviter le N+1 sur le calcul des moyennes à chaque consultation de profil. La solution actuelle (recalcul en eager loading) fonctionne mais ne passera pas à l'échelle avec des milliers d'évaluations. C'est de la dette technique qu'on devra adresser."

**Alice (Product Owner):**
"D'un point de vue produit, la **Story 6-6 (Signalement de problème)** a failli se retrouver en risque de scope creep. On a eu des discussions sur l'intégration avec un éventuel système de médiation ou de remboursement. On a pris la bonne décision de la garder simple (juste l'enregistrement du signalement), mais ça a pris du temps de recadrer."

---

## Leçons Apprises

**Bob (Scrum Master):**
"Voici les leçons concrètes qu'on doit embarquer dans l'Épic 7."

### Lecon 1 — Encapsuler les transitions d'état dans des Enums riches

**Charlie (Senior Dev):**
"L'enum `TrackingStatus` avec `allowedTransitions()` et `canTransitionTo()` est une réussite. Toute la logique de séquencement est en un seul endroit, auto-testable, et lisible. **Règle à généraliser :** chaque fois qu'on a un statut avec des transitions contraintes (booking, paiement, contrat…), on crée un Enum riche avec ces méthodes. Pas de logique de transition dans les controllers."

### Lecon 2 — Anticiper la gestion des permissions mobiles dans les stories

**Elena (Junior Dev):**
"Quand une story implique une permission système (GPS, caméra, micro…), on doit inclure explicitement dans les AC les cas `denied`, `denied_forever` et `service_disabled`. Ces cas ne sont pas des edge cases — ce sont des chemins principaux sur iOS et Android. On les ajoute dans la définition of done dès le grooming."

### Lecon 3 — Tester l'égalité des états Bloc quand on utilise l'héritage

**Elena (Junior Dev):**
"Si un état hérite d'un autre (comme `TrackingUpdating extends TrackingLoaded`), il faut systématiquement écrire un test unitaire qui vérifie que Bloc ne supprime pas l'émission. Ce test coûte 5 minutes à écrire et évite une demi-journée de débogage."

### Lecon 4 — Protéger les side effects (broadcast, SMS, email) en try/catch systématique

**Charlie (Senior Dev):**
"La décision d'entourer `broadcast()` en try/catch avec `Log::error` (issue H1, Story 6-1) est un pattern qu'on doit appliquer partout : SMS, email, push notifications, webhooks. Un side effect qui échoue ne doit jamais annuler la transaction principale. On formalise ça comme une règle d'architecture dans notre guide de coding."

### Lecon 5 — Documenter les action items de dette technique dans les stories au moment de la code review

**Dana (QA Engineer):**
"La race condition `preparing` (item M1) a été documentée dans la story 6-1 au moment de la code review. C'est excellent. On systématise ça : tout item identifié en review mais hors scope de la story en cours est immédiatement noté dans la section 'Issues résolues' avec un label clair (H/M/L). Le Product Backlog et le sprint planning suivants s'en trouvent alimentés automatiquement."

---

## Dette Technique

| ID  | Description                                                                                     | Sévérité | Story source | Cible         |
|-----|-------------------------------------------------------------------------------------------------|----------|--------------|---------------|
| DT-601 | Race condition sur le premier statut `preparing` — deux requêtes concurrentes créent deux TrackingEvents. Corriger avec DB lock ou contrainte unique composite `(booking_request_id, status = 'preparing')`. | Haute     | 6-1          | Épic 7 ou backlog dédié |
| DT-602 | Calcul du score moyen talent recalculé à chaque chargement de profil. Ajouter une colonne `average_rating` dénormalisée sur `talent_profiles`, mise à jour via observer Eloquent. | Moyenne  | 6-4, 6-5     | Épic 8 ou story dédiée |
| DT-603 | Gestion des permissions GPS (denied_forever, service_disabled) non couverte par des AC formels dans Story 6-2. Ajouter les AC rétrospectivement et couvrir avec tests d'intégration Flutter. | Moyenne  | 6-2          | Épic 7 (avant Story 7-x GPS) |
| DT-604 | `TrackingUpdating extends TrackingLoaded` : pattern fragile si l'opérateur `==` est modifié sans garde. Ajouter un test de régression qui vérifie que Bloc émet bien lors du passage `Loaded → Updating → Loaded`. | Faible   | 6-8          | Prochain sprint Flutter |

---

## Action Items

| # | Action                                                                                              | Responsable | Échéance    |
|---|-----------------------------------------------------------------------------------------------------|-------------|-------------|
| 1 | Créer une story "Fix race condition TrackingEvent preparing" avec DB lock ou contrainte unique      | Charlie     | Sprint 1 Épic 7 |
| 2 | Créer une story "Dénormaliser average_rating sur TalentProfile"                                    | Charlie + Alice | Sprint 2 Épic 7 |
| 3 | Formaliser la règle "try/catch obligatoire sur les side effects" dans le CONTRIBUTING.md backend    | Charlie     | Cette semaine |
| 4 | Ajouter dans le template de story la section "Permissions requises (mobile)" pour toute story GPS/media | Elena + Bob | Avant grooming Épic 7 |
| 5 | Écrire un test de régression Bloc sur `runtimeType guard` dans `tracking_cubit_test.dart`          | Elena       | Sprint 1 Épic 7 |
| 6 | Alimenter le Product Backlog des items DT-601 à DT-604 comme stories estimées                     | Alice + Bob | Cette semaine |

---

## Aperçu Épic 7 — Gestion Talents & Manager

**Alice (Product Owner):**
"L'Épic 7 va s'attaquer à la **gestion de la relation talent-manager**. Les grandes stories prévues :
- Onboarding manager et association avec les talents
- Dashboard manager : suivi des prestations, revenus, KPIs
- Gestion des disponibilités par le manager au nom du talent
- Notifications manager sur les nouvelles réservations et alertes Jour J
- Écrans Flutter manager : tableau de bord, gestion du roster

Ce qui va changer côté technique : on va introduire un nouveau rôle `manager` dans Spatie Permissions, des policies multi-entités (le manager peut agir au nom de ses talents), et probablement une couche de filtrage par `manager_id` sur les requêtes booking. Charlie, anticipe ce scope lors du grooming."

**Charlie (Senior Dev):**
"Noté. Je vais également regarder si on peut extraire un pattern générique pour les policies 'agir au nom de' — ça va revenir aussi pour les agences."

**Bob (Scrum Master):**
"On planifie le grooming Épic 7 pour le 2026-02-24. J'enverrai la convocation lundi. Elena, prépare un inventaire des routes Flutter existantes qui devront exposer une vue manager — on ne veut pas dupliquer des pages entières pour un rôle différent."

**Elena (Junior Dev):**
"Je m'en occupe avant jeudi."

---

## Conclusion — Mode Party

**Bob (Scrum Master):**
"Pour clore cette rétro : Épic 6 — Suivi Jour J & Évaluation — c'est **9 stories, 9 done, 100 %**. On a livré du GPS temps réel avec broadcasting WebSocket, un système d'évaluation bidirectionnel propre, un enrichissement de portfolio post-prestation, et deux écrans Flutter avec animations, optimistic UI et gestion d'erreurs robuste.

C'est de la vraie valeur produit, délivrée sur une stack technique moderne, avec une couverture de tests sérieuse. Je suis fier de chacun d'entre vous."

**Alice (Product Owner):**
"BookMi Jour J est maintenant une réalité. Les talents peuvent gérer leur prestation de bout en bout depuis leur téléphone. Les clients ont la visibilité qu'ils attendaient. On construit quelque chose qui va vraiment changer la façon dont les talents sont recrutés en Côte d'Ivoire."

**Charlie (Senior Dev):**
"L'enum `TrackingStatus` va rejoindre mon panthéon personnel du beau code Laravel. Et la prochaine fois que quelqu'un veut mettre de la logique de transition dans un controller, je leur envoie le lien vers cette story."

**Dana (QA Engineer):**
"19 tests pour l'Épic 6 côté backend, 12 côté Flutter. Ça c'est de la qualité sérieuse. On continue sur cette lancée."

**Elena (Junior Dev):**
"`runtimeType == other.runtimeType`. Je ne l'oublierai jamais. Et l'overlay de célébration — j'espère que les utilisateurs l'apprécieront autant que moi j'ai aimé le coder."

**Aboubakarouattara (Project Lead):**
"Merci à toute l'équipe. On a prouvé à chaque épic qu'on peut livrer de la qualité, de la valeur, et de la documentation honnête. L'Épic 7 nous attend. Allons-y avec le même état d'esprit."

**Bob (Scrum Master):**
"Chapeau à tous. Rétro terminée. À la semaine prochaine pour le grooming Épic 7."

---

*Rétrospective générée le 2026-02-19 par Bob (Scrum Master BMAD) — BookMi_v2*
*Prochaine étape : Grooming Épic 7 — Gestion Talents & Manager — 2026-02-24*
