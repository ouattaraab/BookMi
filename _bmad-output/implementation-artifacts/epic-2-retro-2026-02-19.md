# Retrospective — Epic 2 : Authentification

**Projet :** BookMi_v2 — Marketplace de réservation de talents en Côte d'Ivoire
**Epic :** Epic 2 — Authentification (6 stories)
**Date :** 2026-02-19
**Animateur :** Bob (Scrum Master)
**Format :** Party-mode BMAD

---

## Métriques de l'Epic

| Indicateur | Valeur |
|---|---|
| Stories planifiées | 6 |
| Stories terminées | 6 (100%) |
| Code reviews effectuées | 1 (Story 2-6, 2026-02-19) |
| Tests backend Laravel | 243 (867 assertions) — tous passent |
| Tests Flutter | 210 (50 nouveaux auth + 160 existants) |
| Bugs critiques trouvés en review (backend) | 2 Critical + 2 High (Story 2.1) |
| Bugs trouvés en review (Flutter 2-6) | 1 High + 1 Medium + 2 Low |
| Bugs corrigés avant livraison | 100% des High et Critical |
| Dettes techniques créées (Flutter 2-6) | 4 (M1, M2, M4, L3) |
| Violations Pint / PHPStan | 0 |
| Violations dart analyze | 0 |

---

## Sommaire des 6 Stories

| Story | Titre | Status | Détail |
|---|---|---|---|
| 2-1 | Inscription client et talent | done | Spatie Permission v7, OTP stub, 24 tests |
| 2-2 | Vérification OTP téléphone | done | Cache lockout, SMS stub, resend limit |
| 2-3 | Connexion email / mot de passe | done | Lockout 15 min, UserLoggedIn event, 21 tests |
| 2-4 | Réinitialisation mot de passe | done | Reset token, anti-énumération |
| 2-5 | Déconnexion et gestion token | done | Revocation Sanctum, AuthSessionExpired |
| 2-6 | Écrans authentification Flutter | done | BLoC pattern, GoRouter guard, 50 tests Flutter |

---

## Session de Rétrospective

---

**Bob (Scrum Master):** Bonjour tout le monde. On clôture l'Epic 2 Authentification. 6 stories, toutes done, 100% de complétude. Felicitations à l'équipe. Avant de passer à l'Epic 3 Réservation et Contrats, on prend 45 minutes pour réfléchir à ce qui s'est passé — le bon, le difficile, et ce qu'on retient. On commence par les points positifs. Alice, tu veux bien démarrer ?

---

**Alice (Product Owner):** Avec plaisir Bob. Ce qui me frappe le plus c'est qu'on a livré une authentification complète qui couvre vraiment tous les cas métier. L'inscription client ET talent avec les rôles Spatie, la vérification OTP, le lockout après 5 tentatives, la réinitialisation de mot de passe, la déconnexion avec révocation du token côté serveur — tout est là. Et les messages d'erreur sont en français avec des codes métier explicites : `AUTH_INVALID_CREDENTIALS`, `AUTH_PHONE_NOT_VERIFIED`, `AUTH_ACCOUNT_LOCKED`. C'est exactement ce qu'on avait spécifié dans les ACs. Aucune story n'est à moitié finie.

---

**Charlie (Senior Dev):** Du côté technique, je veux saluer trois décisions architecturales qui ont vraiment payé.

Premièrement, l'adoption du **BLoC pattern avec sealed classes** pour Flutter. On avait des `AuthEvent` et `AuthState` avec des types exhaustifs — le compilateur détecte immédiatement les états non gérés dans les `switch`. La story 2-6 a livré 210 tests qui passent et zero warning dart analyze. C'est propre.

Deuxièmement, le **GoRouter guard réactif**. On a branché un `_GoRouterRefreshStream` adapter sur le stream du BLoC, ce qui rend la redirection automatique : dès que l'état passe à `AuthUnauthenticated`, GoRouter recalcule le redirect sans qu'on ait besoin de naviguer manuellement depuis le code business. C'est élégant.

Troisièmement, la **couche Service Laravel** bien séparée. `AuthService` concentre toute la logique : DB transaction pour le register, logique de lockout avec cache keys atomiques, event dispatching. Le controller ne fait qu'orchestrer les appels. Pint + PHPStan à zéro erreur sur l'ensemble des stories.

---

**Dana (QA Engineer):** Je vais rebondir sur ce que dit Charlie. Ce que j'apprécie c'est que les **leçons de stories précédentes ont été documentées et réappliquées**. Dans les Dev Notes de la story 2-3, on avait une section entière "Leçons de Stories 2.1 / 2.2 à suivre impérativement". Et elles ont été suivies : pas de `Cache::has()` + `Cache::get()` en TOCTOU, stockage ISO8601 pour les timestamps de lockout, désactivation des deux classes throttle dans les tests. C'est du knowledge management concret, pas juste de la bonne intention.

La sécurité aussi est solide : même message d'erreur pour email inconnu et mot de passe incorrect (anti-énumération), email normalisé en lowercase avant lookup pour empêcher le contournement du lockout par variation de casse — ce dernier point a été ajouté en code review sur 2-3 et c'est exactement ce genre de truc qu'on rate à la première passe.

---

**Elena (Junior Dev):** Pour moi, ce qui s'est bien passé c'est la lisibilité du code. Quand j'ai lu `AuthService.login()` pour la première fois, le flow est clair : vérifier lockout, chercher user, vérifier password, vérifier phone vérifié, vérifier is_active, succès. Cinq vérifications ordonnées, chacune avec son code d'erreur. Et du côté Flutter, les sealed classes rendent chaque état nommé et explicite : `AuthAuthenticated`, `AuthRegistrationSuccess`, `AuthFailure`. Pas de champ `isLoading: bool` dispersé partout. En tant que dev junior ça m'aide vraiment à comprendre les transitions d'état.

---

**Bob (Scrum Master):** Parfait. Passons aux points difficiles. Qu'est-ce qui a été compliqué ou qui nous a fait trébucher ?

---

**Charlie (Senior Dev):** Je vais être direct : le **bug H1 sur la story 2-6**. `onboardingRepo` absent du constructeur `_AppDependencies` dans `app.dart`. C'est un compile error — l'app ne compile pas du tout. Ce bug a été livré avec la story et détecté uniquement lors du code review manuel le 2026-02-19. On aurait dû le catcher avant.

Pourquoi ça s'est passé ? Parce qu'on a modifié le constructeur de `_AppDependencies` pour ajouter `AuthRepository` et les autres dépendances, mais on a oublié de wirer `onboardingRepo` qui existait déjà. C'est une erreur de merge/coordination. Et le test de routing `app_router_test.dart` n'a pas détecté le problème parce qu'il mockait les dépendances de manière trop partielle.

---

**Dana (QA Engineer):** Dans la même veine, le **bug M3 — regex email dupliquée** dans `login_page.dart` et `register_page.dart`. Ce n'est pas un crash, mais c'est une violation du principe DRY qu'on aurait dû attraper dès la première passe de review. Deux regex identiques en dur dans deux fichiers différents — si on change les règles de validation email demain, il faut se souvenir de modifier les deux endroits. La correction est simple : extraire dans `lib/core/validators/form_validators.dart`. Ça aurait dû être fait dès l'implémentation.

---

**Aboubakarouattara (Project Lead):** Je veux noter quelque chose sur la story 2-6 plus généralement. La **violation de l'architecture BLoC dans `RegisterPage`** — c'est la dette M1. La méthode `_loadCategories()` appelle directement `AuthRepository` depuis le widget, ce qui contourne complètement le BLoC. On a livré la story avec cette violation délibérément documentée comme dette technique, mais c'est un signal : quand une page est complexe (formulaire multi-champs + appel API dynamique), l'architecture BLoC demande plus de réflexion en amont pour éviter les raccourcis.

---

**Elena (Junior Dev):** Pour moi, la difficulté principale c'était de comprendre la **configuration Spatie Permission v7 avec le guard `api`**. Le piège c'est que Spatie v7 utilise par défaut le guard du modèle, pas un guard global configuré. On a dû ajouter `$guard_name = 'api'` directement sur le modèle `User` après avoir eu un mismatch en tests. Ce n'est pas intuitif et la documentation ne saute pas aux yeux. Heureusement le debug log dans la story 2-1 le documente clairement pour la suite.

---

**Bob (Scrum Master):** Excellents points. On passe aux leçons apprises. Charlie ?

---

## Leçons apprises

**Charlie (Senior Dev):**

### Lecon 1 — Les tests de compilation doivent couvrir le wiring des dépendances

Le bug H1 (compile error `onboardingRepo`) révèle un angle mort : quand on ajoute des dépendances à `_AppDependencies`, il faut un test ou une CI step qui compile l'app complète en mode debug, pas seulement les tests unitaires qui mockent. Pour les prochaines stories Flutter, on doit s'assurer que `flutter build apk --debug` (ou `flutter analyze` complet avec résolution des types) fait partie de la Definition of Done.

### Lecon 2 — Extraire les helpers de validation dans `core/` dès la première implémentation

La regex email dupliquée (M3) aurait dû vivre dans `core/validators/form_validators.dart` dès la story 2-6. Règle simple : toute règle de validation utilisée dans plus d'un écran va dans `core/validators/`. On l'applique dès la story 3.

### Lecon 3 — Planifier les events BLoC pour les cas complexes avant de coder les pages

La violation BLoC dans `RegisterPage` (M1) vient d'une complexité non anticipée : charger des catégories depuis l'API pendant l'inscription. Si on avait conçu les events `AuthCategoriesRequested` et l'état `AuthCategoriesLoaded` avant de coder la page, on n'aurait pas eu besoin du raccourci d'appel direct au repository. Pour l'Epic 3, on définit les events et states du BLoC concerné avant de toucher aux pages.

### Lecon 4 — La normalisation des inputs doit être systematique et faire l'objet d'un test explicite

L'email lowercase dans `login()` (fix H1 de la story 2-3) était une correction de code review, pas un AC original. Pourtant c'est un vecteur de sécurité réel : `USER@email.com` vs `user@email.com` contournait le lockout. Pour l'Epic 3, toute normalisation d'input (casse, trim, format) doit avoir un test unitaire dédié.

### Lecon 5 — Documenter explicitement les dettes techniques avec un ID, une priorité et une raison

Les dettes M1, M2, M4, L3 de la story 2-6 sont documentées avec ID, severite, description et priorité P2/P3. C'est le bon format. On a manqué de le faire systematiquement sur les stories backend 2-1 à 2-5 — les Action Items du code review sont en format libre. Pour l'Epic 3, chaque dette technique a un ID, une priorité et une estimation rough.

---

**Dana (QA Engineer):**

### Lecon 6 — Un code review adversarial paie sur le premier epic

Sur les stories backend (2-1, 2-2, 2-3), les code reviews ont trouvé des issues critiques : `DatabaseSeeder` avec la colonne `name` supprimée (crash au seed), OTP visible en clair dans les logs (fuite de sécurité), normalisation email manquante (bypass du lockout). Aucune de ces issues n'était un oubli grossier — elles demandent un regard externe. Le pattern adversarial review doit continuer sur chaque story de l'Epic 3.

---

## Dette technique héritée de l'Epic 2

Issues documentées dans la story 2-6, à traiter en Epic 3 ou au début de l'Epic 4 :

| ID | Sévérité | Description | Priorité | Story cible |
|----|----------|-------------|----------|-------------|
| M1 | MEDIUM | `RegisterPage._loadCategories()` appelle `AuthRepository` directement — viole BLoC. Créer `AuthCategoriesRequested` event et handler dans `AuthBloc`. | P2 | Epic 3 début |
| M2 | MEDIUM | `AuthRepository.getProfile()` retourne `AuthResponse(token: '')` — token vide sémantiquement incorrect pour un `GET /me`. Rendre `token` nullable ou créer un modèle `UserProfile` séparé. | P2 | Epic 3 début |
| M4 | MEDIUM | AC9 (dark mode) non couvert par les tests widget Auth. Les tests vérifient le rendu light mode uniquement. | P3 | Avant release bêta |
| L3 | LOW | `AuthRegisterSubmitted.data` est `Map<String, dynamic>` non typé. Créer un value object `RegisterRequest` pour encoder les contraintes métier au niveau du type system. | P3 | Epic 3 ou 4 |

**Action requise :** M1 et M2 doivent être traités avant la story 3.1 pour ne pas propager l'architecture incorrecte.

---

## Action Items pour l'Epic 3

| # | Action | Responsable | Quand | Critère de Done |
|---|--------|-------------|-------|-----------------|
| A1 | Créer `AuthCategoriesRequested` event + handler dans `AuthBloc` et refactorer `RegisterPage._loadCategories()` | Dev Flutter | Début Epic 3 | `dart analyze` propre, test BLoC pour l'event |
| A2 | Rendre `AuthResponse.token` nullable ou créer `UserProfile` model pour `getProfile()` | Dev Flutter | Début Epic 3 | Tous les tests auth passent, sémantique correcte |
| A3 | Ajouter `flutter build apk --debug` (ou équivalent) à la Definition of Done des stories Flutter | Bob | Avant démarrage Epic 3 | Documenté dans le DoD |
| A4 | Créer `test/features/auth/presentation/pages/*_dark_mode_test.dart` pour les 3 pages principales | Dana | Epic 3 Sprint 1 | Dark mode testé pour Login, Register, OTP |
| A5 | Ajouter une règle de convention : toute validation multi-page dans `core/validators/` | Charlie | Session de kick-off Epic 3 | Convention documentée dans `CONTRIBUTING.md` |
| A6 | Pour chaque story Epic 3 : définir les BLoC events/states AVANT le code des pages | Charlie | Kick-off Epic 3 | Events et states validés par Charlie avant impl |

---

## Apercu de l'Epic 3 — Réservation et Contrats

**Aboubakarouattara (Project Lead):** On a une base d'authentification solide. Le token Sanctum 24h est en place, l'AuthGuard GoRouter protège les routes, le BLoC gère les états de session. L'Epic 3 va s'appuyer entièrement sur ça.

Les grandes stories de l'Epic 3 sont :

- **3-1 : Recherche et filtrage de talents** — endpoint `GET /talents` avec filtres catégorie, sous-catégorie, localisation, budget, disponibilité. Côté Flutter : écran Discovery avec FilterBar, TalentCard, pagination.
- **3-2 : Profil public talent** — endpoint `GET /talents/{id}`, écran profil avec packages, avis, disponibilités. Composants TalentCard et ServicePackageCard déjà créés en Epic 1.
- **3-3 : Système de réservation** — endpoint `POST /bookings` avec gestion des créneaux, durée, package sélectionné. Modèle `Booking` avec statuts (pending, confirmed, cancelled, completed).
- **3-4 : Contrats numériques** — génération PDF du contrat après confirmation, stockage S3, lien de téléchargement.
- **3-5 : Notifications de réservation** — events Laravel + notifications push Firebase pour les transitions de statut.
- **3-6 : Écrans réservation Flutter** — BLoC `BookingBloc`, formulaire de réservation, recap contrat, historique.

Les dettes M1 et M2 de l'Epic 2 doivent être soldées avant la story 3-6.

---

## Conclusion

**Bob (Scrum Master):** Bilan de l'Epic 2 : on a livré un système d'authentification production-ready. 6 stories done, 0 story à moitié faite. Les patterns sont posés — Service Layer, BLoC pattern, sealed classes, GoRouter guard, test coverage systématique. Les code reviews ont été efficaces et ont attrapé des bugs importants avant qu'ils n'arrivent en staging.

Les six leçons retenues sont actionnables et concrètes. Les quatre dettes techniques sont documentées avec ID et priorité. Les six action items pour l'Epic 3 ont un responsable et un critère de done.

**Alice (Product Owner):** Du point de vue produit, les utilisateurs pourront s'inscrire, vérifier leur téléphone, se connecter et récupérer leur mot de passe. La sécurité est au rendez-vous — lockout, anti-énumération, OTP masqué dans les logs. On est prêts à montrer l'app à des bêta-testeurs sur les écrans d'auth.

**Charlie (Senior Dev):** Architecturalement propre. On n'a pas de shortcuts qui vont nous mordre dans deux mois — sauf les quatre dettes documentées qu'on va adresser methodiquement.

**Dana (QA Engineer):** 453 tests au total (backend + Flutter) qui passent. La couverture n'est pas parfaite — le dark mode est un trou — mais les chemins critiques sont testés.

**Elena (Junior Dev):** J'ai beaucoup appris sur la configuration Spatie Permission, les cache keys atomiques, et le BLoC pattern. Les Dev Notes des stories sont précieuses. Je vais continuer à les lire attentivement avant de coder.

**Aboubakarouattara (Project Lead):** L'Epic 2 est terminé. On passe à la réservation. Merci à tous.

**Bob (Scrum Master):** Merci l'équipe. Kick-off Epic 3 vendredi. Bon boulot.

---

*Document généré le 2026-02-19 — Scrum Master Bob (BMAD)*
*BookMi_v2 — Epic 2 Retrospective*
