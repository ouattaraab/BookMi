# Retrospective — Epic 3 : Reservation & Contrats
**Date :** 2026-02-19
**Facilitateur :** Bob (Scrum Master)
**Projet :** BookMi_v2 — Marketplace de reservation de talents en Cote d'Ivoire
**Stack :** Laravel 12 Backend + Flutter 3 Mobile

---

## Metriques de l'Epic

| Indicateur | Valeur |
|---|---|
| Stories planifiees | 10 |
| Stories done | **10 / 10** |
| Taux de completion | **100%** |
| Stories backend | 8 (3-1 a 3-8) |
| Stories Flutter | 2 (3-9, 3-10) |
| Tests backend (cumul final) | **390+ tests, 1300+ assertions** |
| Tests Flutter (BLoC + Widget) | **16 tests** |
| Migrations creees | **9 migrations** |
| Corrections code review | 6 bugs corrigees (3 par story Flutter) |
| Agent IA utilise | Claude Sonnet 4.6 |

---

## Participants

- **Bob** — Scrum Master, facilitateur
- **Alice** — Product Owner
- **Charlie** — Senior Dev (backend Laravel)
- **Dana** — QA Engineer
- **Elena** — Junior Dev (Flutter)
- **Aboubakarouattara** — Project Lead

---

## Tour de chauffe — Mot pour decrire l'Epic 3

**Bob (Scrum Master):** Bienvenue en retrospective de l'Epic 3 ! On a livre un systeme de reservation complet en 10 stories. Avant de plonger, chaque participant donne UN mot pour decrire cet epic. Je commence : **"Complexite"**. C'est l'epic le plus dense qu'on ait fait — machine a etats, generation PDF, politique graduee, report bidirectionnel. Dense mais on l'a fait.

**Alice (Product Owner):** **"Fondation"**. Tout ce qu'on construit en Epic 4 (paiement) repose sur ce qu'on a livre ici. Chaque field qu'on a ajoute — `refund_amount`, `contract_path`, `is_express` — c'est une brique pour la suite.

**Charlie (Senior Dev):** **"Orchestration"**. Ce n'est plus juste du CRUD. On a un vrai systeme : CalendarService, BookingService, RescheduleService, des events, des jobs queued, des policies a chaque couche. C'etait du vrai genie logiciel.

**Dana (QA Engineer):** **"Robustesse"**. Les 11 edge cases de la politique d'annulation, les transitions d'etats invalides, les conflits de reschedule — tout etait couvert. Zero regression visible en revue.

**Elena (Junior Dev):** **"Profondeur"**. J'ai appris enormement sur ce sprint. Le BLoC pattern pour le flow de reservation, la gestion des race conditions dans l'UI Flutter — c'etait intense mais formateur.

**Aboubakarouattara (Project Lead):** **"Confiance"**. On livre des fonctionnalites critiques pour une marketplace — les gens vont signer des contrats et payer via ce systeme. Voir 100% de stories done avec des tests qui couvrent tous les cas me donne confiance pour la suite.

---

## WENT WELL — Ce qui a bien marche

### 1. Le calendrier de disponibilites (Story 3-1) : architecture propre des le depart

**Bob (Scrum Master):** Story 3-1, le calendrier — qu'est-ce qui a vraiment bien fonctionne ?

**Charlie (Senior Dev):** La decision de faire `CalendarSlotStatus.Confirmed` comme statut virtuel — pas stocke en base, injecte par le service au moment de la requete. Ca evite toute desynchronisation entre la table `booking_requests` et `calendar_slots`. Une seule source de verite pour l'etat confirme. En plus, la methode `isDateAvailable()` qu'on a anticipee dans `CalendarService` a ete reutilisee directement par `BookingService` en story 3-2. Zero refactoring.

**Alice (Product Owner):** Ce que j'apprecie c'est qu'on ait prevu l'AC2 de 3-1 (lister par mois avec les reservations confirmees) meme quand la table `booking_requests` n'existait pas encore. Le service faisait un "graceful skip" de la table absente. Ca a permis de livrer 3-1 en isolation totale.

**Dana (QA Engineer):** Les 15 tests de calendrier couvrent le conflit de date (409), la validation, la modification avec Policy, la suppression. Aucun test flaky detecte sur cette story.

---

### 2. Le systeme de devis transparent (Story 3-4) : zero migration, zero friction

**Charlie (Senior Dev):** Story 3-4 c'est le bon exemple de refactoring chirurgical. Aucune migration. Les colonnes `description`, `inclusions`, `duration_minutes` existaient deja sur `service_packages` depuis Epic 1 — on les avait juste pas exposees. On a mis a jour les selects dans 4 endroits (controller x3, service x1), enrichi la resource, et on a livre.

**Dana (QA Engineer):** Le fait que le message `"Cachet artiste intact — BookMi ajoute 15% de frais de service"` soit une constante metier dans la resource — pas en base, pas en config — c'est propre. Si on veut le changer, c'est un seul endroit. Et les 5 tests couvrent tous les endpoints qui retournent `BookingRequestResource`.

**Alice (Product Owner):** Du point de vue produit, c'est le meilleur ratio valeur/effort de l'epic. Les clients voient exactement ce qu'ils paient, le talent voit que son cachet est intact. C'est la confiance qu'on vend, et on la code en une demi-journee.

---

### 3. Le contrat electronique PDF (Story 3-5) : architecture asynchrone bien concue

**Bob (Scrum Master):** La generation PDF — qu'est-ce qui nous a bien servi ?

**Charlie (Senior Dev):** La decision de mettre la generation PDF dans un Job queue sur la queue `media` plutot qu'en synchrone dans le controller. L'utilisateur recoit sa reponse 200 immediatement apres acceptation, le PDF se genere en arriere-plan. L'endpoint `/contract` retourne 404 `BOOKING_CONTRACT_NOT_READY` si le job n'a pas encore tourne — comportement propre et testable.

**Elena (Junior Dev):** Cote Flutter, le champ `contract_available: true/false` dans la resource nous permet d'afficher ou masquer le bouton "Telecharger le contrat" dans `BookingDetailPage` sans aucune logique cote mobile. L'etat vient du backend.

**Dana (QA Engineer):** `Queue::fake()` + `Queue::assertPushedOn('media', GenerateContractPdf::class)` — le test AC1 est propre et rapide. `Storage::fake('local')` pour le test de download — aucune ecriture disque reelle. Ces patterns sont reutilisables pour Epic 4 (jobs de versement).

**Charlie (Senior Dev):** Un point technique important : on ne peut pas declarer `public string $queue = 'media'` directement sur la classe Job car le trait `Queueable` definit deja `$queue`. La solution `->onQueue('media')` dans `BookingService` est plus explicite de toute facon.

---

### 4. Le flow de reservation Flutter (Story 3-9) : UX de qualite production

**Elena (Junior Dev):** Le bottom sheet en 3 etapes avec `StepperProgress` anime — le resultat visuel est vraiment propre. L'extraction d'ID robuste dans `Step1PackageSelection` (`attrs['id'] ?? pkg['id'] ?? index`) evite les crashs si l'API change son format de reponse.

**Bob (Scrum Master):** Les corrections de code review sur 3-9 etaient les bonnes : navigation calendrier non bornee (bug UX reel), absence de `didUpdateWidget` sur les controllers (fuite memoire potentielle). La code review a attrape ce qu'elle devait attraper.

**Alice (Product Owner):** Le devis local calcule directement dans le sheet Flutter (`commissionAmount = (cachetAmount * 0.15).round()`) — l'utilisateur voit le total en temps reel pendant qu'il remplit le formulaire, avant meme d'appuyer sur "Valider". C'est de l'UX.

---

### 5. L'ecran Reservations Flutter (Story 3-10) : gestion des etats reactive exemplaire

**Elena (Junior Dev):** `BookingsListLoadingMore extends BookingsListLoaded` — cette decision d'architecture permet d'afficher les donnees existantes + un spinner en bas pendant la pagination. L'utilisateur ne voit jamais un ecran blanc pendant le chargement de la page suivante.

**Charlie (Senior Dev):** La correction du deadlock `RefreshIndicator` est la correction la plus subtile de l'epic. Souscrire au stream AVANT le `bloc.add(...)` — si tu inverses l'ordre, le future ne se resout jamais si l'etat est deja `Loaded`. C'est le genre de bug qu'on ne trouve qu'en production normalement.

**Dana (QA Engineer):** 7 tests widget sur `BookingCard` — badge Express, formatage de date, statuts couleur. Ce sont les tests qui detectent les regressions visuelles. Bien fait.

---

## CHALLENGES — Ce qui a ete difficile

### Challenge 1 : La machine a etats BookingStatus — complexite accumulee story apres story

**Charlie (Senior Dev):** `BookingStatus` a commence avec 7 etats en story 3-2. En story 3-7, on a ajoute la transition `Confirmed → Cancelled` qui n'etait pas prevue initialement. En story 3-8, le reschedule peut s'appliquer a `accepted`, `paid`, `confirmed`. La machine a etats a grossi de facon organique — a chaque story, on touchait le meme enum.

**Dana (QA Engineer):** Chaque modification de `allowedTransitions()` risquait de casser les tests existants. On a eu de la chance que les transitions ajoutees soient additives (on ajoute des possibilites, on n'en retire pas). Mais si on avait du retirer une transition en milieu de sprint, ca aurait ete douloureux.

**Bob (Scrum Master):** Lecon retenue : en Epic 4 et au-dela, si une story touche `BookingStatus`, ca doit etre une tache explicite dans le backlog de cette story, pas une decouverte en cours d'implementation.

---

### Challenge 2 : La reservation express — double event, ordre critique

**Charlie (Senior Dev):** Story 3-6 a introduit un subtilite : en mode express, on dispatch `BookingCreated` AVANT d'appeler `acceptBooking()` (qui dispatch `BookingAccepted`). L'ordre n'est pas arbitraire — un listener futur (story 5.4, notifications push) doit recevoir `BookingCreated` avant `BookingAccepted`. Si on inversait l'ordre, un listener qui reagit a `BookingCreated` pourrait trouver un booking deja en statut `accepted`, ce qui casserait sa logique.

**Alice (Product Owner):** C'est invisible pour l'utilisateur mais c'est un contrat d'architecture. On aurait du documenter ca explicitement dans les Dev Notes de 3-6.

**Elena (Junior Dev):** Cote Flutter, le toggle express dans `Step3Recap` avec la condition `if (enableExpress)` — simple. Mais la validation `is_express: ['nullable', 'boolean']` dans le FormRequest Laravel (sans `nullable`, envoyer `null` fait echouer la validation) — c'est le genre de subtilite qui perd du temps si on ne le sait pas.

---

### Challenge 3 : La politique d'annulation graduee — logique metier dense

**Charlie (Senior Dev):** `cancelBooking()` dans `BookingService` — quatre paliers (>= J-14, J-7 a J-14, J-2 a J-7, < J-2), deux types d'exceptions differentes, un calcul `refund_amount`, deux colonnes a stocker. Et `diffInDays(absolute: false)` qui retourne positif pour le futur, negatif pour le passe — la semantique n'est pas intuitive.

**Dana (QA Engineer):** On a teste 11 cas pour la politique d'annulation. Les cas limites — exactement J-14, exactement J-7, exactement J-2 — sont les plus importants. Un bug off-by-one sur un seuil et un client se retrouve sans remboursement alors qu'il y a droit. Ces tests doivent rester dans la suite a jamais.

**Bob (Scrum Master):** La config `config('bookmi.cancellation')` avec tous les seuils — c'est la bonne decision. Si le metier decide de changer la politique (passer de J-14 a J-10 pour le remboursement integral), c'est un changement de config, pas un changement de code. Mais on aurait du l'ecrire comme ca depuis le debut, pas la decouvrir en story 3-7.

---

### Challenge 4 : Le report de reservation — la story la plus complexe de l'epic

**Charlie (Senior Dev):** Story 3-8 — report bidirectionnel (client ET talent peuvent initier), contrepartie qui repond, une seule demande pending a la fois, transaction atomique qui libere l'ancien slot et bloque le nouveau, 10 acceptance criteria. C'est la story qui aurait pu facilement deborder.

**Dana (QA Engineer):** `authorize('create', [RescheduleRequest::class, $booking])` — la syntaxe array pour passer `$booking` comme argument supplementaire a la Policy. Ce n'est pas dans la doc Laravel en premier plan. On a perdu du temps la-dessus.

**Elena (Junior Dev):** Cote Flutter, le reschedule n'a pas encore d'ecran dedie en Epic 3 — c'est prevu en Epic 5 ou 6. Les endpoints backend existent, le mobile ne les consomme pas encore. C'est une dette d'integration a connaitre.

---

## LECONS APPRISES

### Lecon 1 : Anticiper la machine a etats en debut d'epic

**Bob (Scrum Master):** La `BookingStatus` state machine aurait du etre designee completement en story 3-2 avec TOUTES les transitions de l'epic — y compris `Confirmed → Cancelled` (3-7) et les etats valides pour reschedule (3-8). On a modifie le meme enum dans 3 stories differentes. Pour les epics futurs qui introduisent un cycle de vie d'entite (paiement en Epic 4), on dessine la machine a etats complete avant d'ecrire la premiere ligne de code.

**Action :** Creer un diagramme de machine a etats en phase de planning de chaque epic impliquant un cycle de vie d'entite.

---

### Lecon 2 : Documenter l'ordre des events dispatches

**Charlie (Senior Dev):** L'ordre `BookingCreated` avant `BookingAccepted` en mode express est un contrat implicite avec les futurs listeners (story 5.4). Si un dev en Epic 5 inversait l'ordre pensant que c'est equivalent, ca pourrait casser des comportements. On doit documenter ces contrats explicitement dans les Dev Notes.

**Action :** Ajouter une section "Contrats d'events" dans les Dev Notes de toute story qui dispatche plusieurs events en sequence.

---

### Lecon 3 : Centraliser la logique metier dans la config bookmi.php des le debut

**Alice (Product Owner):** On a `commission_rate = 15` depuis Epic 3. La politique d'annulation (seuils J-14, J-7, J-2) est arrivee en story 3-7. Si on avait design `config/bookmi.php` comme le fichier central de toutes les regles metier depuis le debut, on n'aurait pas eu a le decouvrir a mi-chemin. Ce fichier doit etre le premier endroit ou on regarde avant d'hardcoder une valeur.

**Action :** Toute valeur metier (taux, seuil, duree) va dans `config/bookmi.php` avant d'etre codee. Verifier ce fichier en debut de chaque story.

---

### Lecon 4 : Les race conditions Flutter sont systematiques, pas exceptionnelles

**Elena (Junior Dev):** On a corrige 3 types de race conditions en 2 stories Flutter : `context.read()` apres un `await` (reference invalide), `RefreshIndicator` deadlock (stream non souscrit avant add), navigation calendrier non bornee (pas vraiment une race condition mais un bug UX du meme niveau). Ces patterns reviennent. On devrait avoir une checklist Flutter a appliquer sur chaque nouvelle page.

**Charlie (Senior Dev):** `didUpdateWidget` sur les `TextEditingController` — c'est le bug Flutter le plus frequent quand on recycle des widgets. Si un widget a un controller, il doit implementer `didUpdateWidget`. Sans exception.

**Action :** Creer une checklist "Flutter Widget Safety" : didUpdateWidget sur tous les controllers, capture de context.read() avant les await, stream souscrit avant bloc.add() pour RefreshIndicator.

---

### Lecon 5 : Queue::fake() et Storage::fake() comme premiers reflexes pour les jobs et le stockage

**Dana (QA Engineer):** Les tests de story 3-5 (contrat PDF) ont etabli le pattern : `Queue::fake()` pour verifier qu'un job est dispatche sans l'executer, `Storage::fake('local')` pour simuler le disque sans ecriture reelle. Ces deux utilitaires Laravel sont parfaits et on va en avoir besoin en Epic 4 pour les jobs de versement et les exports financiers. Maintenant qu'on les a utilises, on ne devrait plus hesiter.

**Action :** Pour toute story qui implique un Job ou du stockage de fichier, le test AC correspondant utilise systematiquement Queue::fake() / Storage::fake().

---

## DETTE TECHNIQUE IDENTIFIEE

| ID | Description | Priorite | Epic cible |
|---|---|---|---|
| DT-3-01 | Listeners `BookingCreated`, `BookingAccepted`, `BookingCancelled` sont vides — notifications push manquantes | Haute | Epic 5 |
| DT-3-02 | Ecran Flutter pour le report de reservation (reschedule) absent — endpoints backend existants, aucune UI | Moyenne | Epic 5 ou 6 |
| DT-3-03 | `refund_amount` calcule et stocke mais aucun remboursement reel effectue (pas de paiement encore) | Haute | Epic 4 |
| DT-3-04 | Template PDF `booking-contract.blade.php` utilise des styles inline (DomPDF ne supporte pas les feuilles CSS externes) — maintenabilite reduite | Basse | Epic 4 |
| DT-3-05 | La machine a etats `BookingStatus` n'a pas de diagramme documente — evolution risquee | Moyenne | Epic 4 (planning) |
| DT-3-06 | `GenerateContractPdf` Job n'a pas de retry logic ni de failed_jobs monitoring configure | Moyenne | Epic 4 |
| DT-3-07 | La queue `media` n'est pas definie dans `config/queue.php` avec ses propres workers — risque de partage de workers avec la queue default | Haute | Epic 4 (DevOps) |
| DT-3-08 | Cache Hive bookings (TTL 7 jours) non invalide en cas d'annulation ou report — l'utilisateur pourrait voir des donnees stales | Moyenne | Epic 4 Flutter |

---

## ACTION ITEMS

| # | Action | Responsable | Deadline | Priorite |
|---|---|---|---|---|
| AI-3-01 | Dessiner le diagramme complet de la state machine `BookingStatus` avec les transitions Epic 4 (paid, confirmed, completed) | Charlie | Avant S4 Story 4-1 | Critique |
| AI-3-02 | Configurer la queue `media` dans `config/queue.php` avec workers dedies dans `docker-compose.yml` | Charlie | Avant S4 Story 4-1 | Haute |
| AI-3-03 | Ajouter retry logic sur `GenerateContractPdf` Job (3 tentatives, backoff 60s) | Charlie | Story 4-5 | Haute |
| AI-3-04 | Creer et partager la checklist "Flutter Widget Safety" dans le README mobile | Elena | Avant S4 Story 4-10 | Haute |
| AI-3-05 | Enrichir `config/bookmi.php` avec un commentaire clair sur chaque valeur metier et sa provenance | Alice + Charlie | Avant S4 Story 4-1 | Moyenne |
| AI-3-06 | Implementer l'invalidation du cache Hive au moment de l'annulation ou du report (update BookingRepository) | Elena | Story 4-10 | Moyenne |
| AI-3-07 | Planifier l'ecran reschedule Flutter dans le backlog Epic 5 ou 6 | Alice + Bob | Sprint planning Epic 5 | Moyenne |

---

## APERCU EPIC 4 — Paiement & Sequestre

**Bob (Scrum Master):** Avant de terminer, parlons des dependances critiques entre ce qu'on a livre et Epic 4.

**Alice (Product Owner):** Epic 4 "Paiement & Sequestre" a 10 stories. Les 4 premieres (4-1 a 4-4) sont le coeur du paiement : Paystack Mobile Money, webhooks idempotents, carte bancaire, et le systeme d'escrow. Toutes ces stories consomment directement ce qu'on a livre en Epic 3.

**Charlie (Senior Dev):** Les dependances critiques sont les suivantes :

**Dependance 1 — `BookingStatus::Paid`**
La story 4-1 (integration Paystack) va faire passer une reservation de `accepted` a `paid`. Cette transition est deja dans notre enum (`BookingStatus`), elle est dans `allowedTransitions()`. Le backend Epic 3 est pret.

**Dependance 2 — `refund_amount` et `cancellation_policy_applied`**
On a calcule et stocke le montant de remboursement en story 3-7 mais aucun remboursement reel n'a ete effectue — il n'y avait pas encore de paiement. Story 4-7 (remboursements en cas de litige) va consommer ces champs. La donnee est la, il faut juste la relier au systeme de paiement.

**Dependance 3 — `GenerateContractPdf` Job sur queue `media`**
La queue `media` utilisee par 3-5 doit etre operationnelle avant qu'on ajoute les jobs de versement automatique (4-5). Si la queue n'est pas configuree, les deux types de jobs vont se retrouver sur la queue `default` — risque de contention.

**Dependance 4 — `contract_path` et `contract_available`**
Le contrat PDF genere en 3-5 devient un document legal en Epic 4. Apres le paiement, le client et le talent ont besoin du contrat comme preuve. L'endpoint `GET /booking_requests/{booking}/contract` est deja livre et fonctionne.

**Dependance 5 — `is_express` et auto-acceptation**
En mode express (3-6), la reservation passe directement a `accepted` et le contrat est genere. En Epic 4, le paiement doit suivre immediatement apres acceptation express. Story 4-1 devra traiter ce cas : declencher le flow de paiement automatiquement si `is_express = true`.

**Dana (QA Engineer):** Pour QA Epic 4, la suite de tests Epic 3 est notre filet de securite. Chaque fois qu'on modifie `BookingService` ou `BookingStatus` en Epic 4, on relance les 11 tests de cancellation, les tests de transitions d'etat, et les tests de reschedule. Aucune regression tolerable.

**Elena (Junior Dev):** Cote Flutter, l'ecran de paiement (story 4-10) va s'integrer dans le flow existant : apres l'etape 3 (recapitulatif) du `BookingFlowSheet`, l'etape 4 "Paiement" doit etre couplee a l'API Paystack. On a deja le `StepperProgress` qui affiche 4 etapes — l'etape 4 est visuellement la mais non implementee. C'est exactement ce qu'Epic 4 doit remplir.

**Bob (Scrum Master):** En resume : Epic 3 a construit les rails. Epic 4 fait rouler le train dessus. Les interfaces sont propres, les contrats de donnees sont definis, les tests sont la pour garder les rails droits.

---

## CONCLUSION — Party Mode

**Bob (Scrum Master):** 10 stories. 10 done. 100%. Dans un epic ou on a livre un calendrier de disponibilites avec gestion de conflits, un systeme de reservation avec machine a etats a 7 statuts, une generation de contrat PDF en asynchrone, une reservation express, une politique d'annulation graduee en 4 paliers, un report bidirectionnel avec transaction atomique, un flow de reservation Flutter en bottom sheet 3 etapes, et un ecran de gestion des reservations avec pagination curseur et onglets par statut. On a fait tout ca. En un sprint.

**Alice (Product Owner):** Ce que je retiens : BookMi peut maintenant prendre une reservation de A a Z cote serveur. Un client envoie sa demande, le talent accepte, un contrat est genere, et si ca ne se passe pas bien il peut annuler ou reporter. C'est une plateforme qui fonctionne. En Cote d'Ivoire, dans notre contexte, c'est enorme.

**Charlie (Senior Dev):** La qualite du code sur cet epic est la meilleure qu'on ait produite. Les services sont propres, les policies couvrent tous les cas d'autorisation, les exceptions ont des codes metier lisibles (`BOOKING_CANCELLATION_NOT_ALLOWED`, `BOOKING_RESCHEDULE_SAME_DATE`). Dans 6 mois, quand quelqu'un lira ce code, il comprendra l'intention.

**Dana (QA Engineer):** Plus de 390 tests, plus de 1300 assertions, zero test flaky identifie. La suite de regression pour l'epic le plus critique du projet est solide. Quand Epic 4 arrivera et modifiera `BookingService`, on saura en 30 secondes si quelque chose a casse.

**Elena (Junior Dev):** Les corrections de code review sur les deux stories Flutter — 6 bugs corriges avant de merger. Le deadlock du RefreshIndicator, les fuites sur les TextEditingController, la navigation calendrier non bornee. Ces corrections m'ont appris plus que n'importe quel cours. Je les ai maintenant en memoire pour toujours.

**Aboubakarouattara (Project Lead):** On construit quelque chose de reel pour notre marche. Chaque artiste ivoirien qui va utiliser BookMi pour gerer ses prestations va beneficier de ce travail. Le fait que son cachet soit intact, que les frais soient transparents, qu'il y ait un contrat numerique — c'est de la confiance qu'on code. Merci a toute l'equipe.

**Bob (Scrum Master):** Epic 3 — DONE. Place a l'Epic 4.

---

## Signature

| Role | Nom | Date |
|---|---|---|
| Scrum Master | Bob | 2026-02-19 |
| Product Owner | Alice | 2026-02-19 |
| Senior Dev | Charlie | 2026-02-19 |
| QA Engineer | Dana | 2026-02-19 |
| Junior Dev | Elena | 2026-02-19 |
| Project Lead | Aboubakarouattara | 2026-02-19 |

---

*Document genere par Bob (Scrum Master Agent) — BookMi_v2 — 2026-02-19*
